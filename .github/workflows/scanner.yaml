name: üöÄ Enhanced Subdomain & Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Leave default to use secret, or enter new domains here (space-separated)'
        required: true
        default: 'Use targets from secret'
  schedule:
    # Every Monday at 6 AM UTC
    - cron: '0 6 * * 1'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      domains: ${{ steps.set-domains.outputs.domains }}
    steps:
      - name: Prepare Domain List
        id: set-domains
        run: |
          PLACEHOLDER='Use targets from secret'
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.domain }}" != "$PLACEHOLDER" ]; then
              domains_string="${{ github.event.inputs.domain }}"
              echo "Using user-provided domains from manual trigger."
            else
              domains_string="${{ secrets.TARGET_DOMAIN }}"
              echo "User left default value, falling back to TARGET_DOMAIN secret."
            fi
          else
            domains_string="${{ secrets.TARGET_DOMAIN }}"
            echo "Using TARGET_DOMAIN secret for scheduled run."
          fi

          if [ -z "$domains_string" ]; then
            echo "::error::Domain list is empty. Check your input or the TARGET_DOMAIN secret."
            exit 1
          fi

          json_array=$(echo "$domains_string" | jq -R 'split(" ") | map(select(. != ""))' | jq -c .)
          echo "Final JSON for matrix: $json_array"
          echo "domains=$json_array" >> $GITHUB_OUTPUT

  scan:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        domain: ${{ fromJson(needs.setup.outputs.domains) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip wget git build-essential ca-certificates
          echo "GOBIN=$HOME/go/bin" >> $GITHUB_ENV
          echo "PATH=$PATH:$HOME/go/bin" >> $GITHUB_ENV
          # Install discovery tools
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/tomnomnom/assetfinder@latest || true
          go install -v github.com/owasp/amass/v3/...@master || true
          # Install verification and scanning tools
          go install -v github.com/projectdiscovery/dnsx/cmd/dnsx@latest || true
          go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest || true
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest || true
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest || true

      - name: Validate Discord Secret
        run: |
          if [ -z "${{ secrets.DISCORD_GHOST }}" ]; then
            echo "::error::DISCORD_GHOST secret is not set."
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_GHOST }}" >> $GITHUB_ENV

      - name: üîç Notify Scan Started for ${{ matrix.domain }}
        run: |
          curl -s -X POST -H "Content-Type: application/json" -d "{
            \"content\": \"üîç **Scan Started for Domain:** `${{ matrix.domain }}`\n**Trigger:** `${{ github.event_name }}`\"
          }" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: üåê Run Asset Discovery for ${{ matrix.domain }}
        run: |
          echo "--- 1. Subdomain Discovery ---"
          subfinder -d ${{ matrix.domain }} -silent -o subfinder.txt
          assetfinder --subs-only ${{ matrix.domain }} > assetfinder.txt
          amass enum -passive -d ${{ matrix.domain }} -o amass.txt
          cat subfinder.txt assetfinder.txt amass.txt | sort -u > all-subs.txt
          echo "Total raw subdomains found: $(wc -l < all-subs.txt)"

          echo "--- 2. Subdomain Verification ---"
          cat all-subs.txt | dnsx -silent -o alive-subs.txt
          echo "TOTAL_ALIVE_SUBS=$(wc -l < alive-subs.txt)" >> $GITHUB_ENV
          echo "Total alive subdomains: ${{ env.TOTAL_ALIVE_SUBS }}"

      - name: üîß Identify Technologies for ${{ matrix.domain }}
        run: |
          echo "--- 3. Technology Identification ---"
          # -screenshot can be added if you want visual proof, but it increases artifact size
          cat alive-subs.txt | httpx -title -tech-detect -status-code -o tech-results.txt
          echo "Technology identification complete."

      - name: üö™ Scan Open Ports for ${{ matrix.domain }}
        run: |
          echo "--- 4. Port Scanning ---"
          cat alive-subs.txt | naabu -top-ports 1000 -silent -o ports.txt
          echo "TOTAL_OPEN_PORTS=$(wc -l < ports.txt)" >> $GITHUB_ENV
          echo "Total open ports found: ${{ env.TOTAL_OPEN_PORTS }}"

      - name: üìä Notify Discovery Summary for ${{ matrix.domain }}
        run: |
          TECH_SAMPLE=$(head -n 10 tech-results.txt)
          MESSAGE="‚úÖ **Asset Discovery Complete**\n**Domain:** `${{ matrix.domain }}`\n\n**Summary:**\n- üåê Alive Subdomains: `${{ env.TOTAL_ALIVE_SUBS }}`\n- üö™ Open Ports: `${{ env.TOTAL_OPEN_PORTS }}`\n\n**Technology Sample:**\n\`\`\`\n$TECH_SAMPLE\n\`\`\`"
          if [ ${#MESSAGE} -gt 1950 ]; then
            MESSAGE="‚úÖ **Asset Discovery Complete**\n**Domain:** `${{ matrix.domain }}`\n- üåê Alive Subdomains: `${{ env.TOTAL_ALIVE_SUBS }}`\n- üö™ Open Ports: `${{ env.TOTAL_OPEN_PORTS }}`\n\n(Results list truncated due to size)"
          fi
          curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: üõ°Ô∏è Update Nuclei Templates
        run: nuclei -update-templates

      - name: üö® Run Nuclei Vulnerability Scan for ${{ matrix.domain }}
        run: |
          echo "--- 5. Vulnerability Scanning ---"
          nuclei -l alive-subs.txt -severity critical,high,medium -tags cve,exposure,misconfig -silent -o nuclei-results.txt -rate 50
          [ -f nuclei-results.txt ] || touch nuclei-results.txt
          echo "NUCLEI_VULNS_FOUND=$(wc -l < nuclei-results.txt)" >> $GITHUB_ENV
          echo "Total vulnerabilities found: ${{ env.NUCLEI_VULNS_FOUND }}"

      - name: üì¢ Notify Vulnerability Summary for ${{ matrix.domain }}
        run: |
          if [ "${{ env.NUCLEI_VULNS_FOUND }}" -gt 0 ]; then
              MESSAGE="üö® **Vulnerabilities Found!**\n**Domain:** `${{ matrix.domain }}`\n**Total:** `${{ env.NUCLEI_VULNS_FOUND }}`\n\nSending details..."
          else
              MESSAGE="‚úÖ **Vulnerability Scan Complete**\n**Domain:** `${{ matrix.domain }}`\nNo critical/high/medium vulnerabilities found."
          fi
          curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": \"$MESSAGE\"}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: üö® Send Nuclei Vulnerabilities for ${{ matrix.domain }}
        if: env.NUCLEI_VULNS_FOUND != '0'
        run: |
          while IFS= read -r vuln; do
              MESSAGE="üö® **Nuclei Vulnerability Found**\n**Domain:** `${{ matrix.domain }}`\n\`\`\`\n$vuln\n\`\`\`"
              curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" "${{ env.DISCORD_WEBHOOK}" || true
              sleep 1
          done < nuclei-results.txt

      - name: üì¶ Upload Scan Artifacts for ${{ matrix.domain }}
        uses: actions/upload-artifact@v4
        if: always() # Upload artifacts even if the scan fails
        with:
          name: scan-results-${{ matrix.domain }}-${{ github.run_number }}
          path: |
            all-subs.txt
            alive-subs.txt
            tech-results.txt
            ports.txt
            nuclei-results.txt
          retention-days: 30
