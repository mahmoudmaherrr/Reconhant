name: Subdomain & Vulnerability Scanner (Final)

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Leave default to use secret, or enter new domains here (space-separated)'
        required: true
        # A static, safe default value to avoid parsing errors.
        default: 'Use targets from secret'
  schedule:
    # Every Monday at 6 AM UTC
    - cron: '0 6 * * 1'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      domains: ${{ steps.set-domains.outputs.domains }}
    steps:
      - name: Prepare Domain List
        id: set-domains
        run: |
          # This is the placeholder text from the 'default' input
          PLACEHOLDER='Use targets from secret'

          # Logic to decide which domain list to use
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, check if the user changed the default placeholder
            if [ "${{ github.event.inputs.domain }}" != "$PLACEHOLDER" ]; then
              # If they changed it, use their new input
              domains_string="${{ github.event.inputs.domain }}"
              echo "Using user-provided domains from manual trigger."
            else
              # If they left the placeholder, fall back to the secret
              domains_string="${{ secrets.TARGET_DOMAIN }}"
              echo "User left default value, falling back to TARGET_DOMAIN secret."
            fi
          else
            # For scheduled runs, always use the secret
            domains_string="${{ secrets.TARGET_DOMAIN }}"
            echo "Using TARGET_DOMAIN secret for scheduled run."
          fi

          # Final check to ensure we have a non-empty domain string
          if [ -z "$domains_string" ]; then
            echo "::error::Domain list is empty. Check your input or the TARGET_DOMAIN secret."
            exit 1
          fi

          # Convert the space-separated string into a JSON array for the matrix
          #
          # !!! THIS IS THE MODIFIED LINE !!!
          # It now filters out empty strings ("") resulting from extra spaces.
          json_array=$(echo "$domains_string" | jq -R 'split(" ") | map(select(. != ""))' | jq -c .)
          #
          #
          
          echo "Final JSON for matrix: $json_array"
          echo "domains=$json_array" >> $GITHUB_OUTPUT

  scan:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        domain: ${{ fromJson(needs.setup.outputs.domains) }}

    steps:
      # ... (All other steps for installation, scanning, and notifications remain exactly the same) ...
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip wget git build-essential ca-certificates
          echo "GOBIN=$HOME/go/bin" >> $GITHUB_ENV
          echo "PATH=$PATH:$HOME/go/bin" >> $GITHUB_ENV
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/tomnomnom/assetfinder@latest || true
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest || true

      - name: Validate Discord Secret
        run: |
          if [ -z "${{ secrets.DISCORD_GHOST }}" ]; then
            echo "::error::DISCORD_GHOST secret is not set."
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_GHOST }}" >> $GITHUB_ENV

      - name: Notify Start for ${{ matrix.domain }}
        run: |
          curl -s -X POST -H "Content-Type: application/json" -d "{
            \"content\": \"🔍 **Scan Started for Domain:** `${{ matrix.domain }}`\n**Trigger:** `${{ github.event_name }}`\"
          }" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Run Subdomain Discovery for ${{ matrix.domain }}
        run: |
          subfinder -d ${{ matrix.domain }} -silent -o subfinder-subs.txt || true
          assetfinder --subs-only ${{ matrix.domain }} > assetfinder-subs.txt || true
          cat subfinder-subs.txt assetfinder-subs.txt | sort -u > subdomains.txt
          echo "SUBFINDER_SUBS_FOUND=$(wc -l < subfinder-subs.txt)" >> $GITHUB_ENV
          echo "ASSETFINDER_SUBS_FOUND=$(wc -l < assetfinder-subs.txt)" >> $GITHUB_ENV
          echo "TOTAL_SUBDOMAINS_FOUND=$(wc -l < subdomains.txt)" >> $GITHUB_ENV

      - name: Notify Subdomain Results for ${{ matrix.domain }}
        run: |
          SUBDOMAINS_CONTENT=$(head -n 20 subdomains.txt)
          MESSAGE="✅ **Subdomain Discovery Complete**\n**Domain:** ${{ matrix.domain }}\n**Subfinder:** ${{ env.SUBFINDER_SUBS_FOUND }}\n**Assetfinder:** ${{ env.ASSETFINDER_SUBS_FOUND }}\n**Total Unique:** ${{ env.TOTAL_SUBDOMAINS_FOUND }}\n\n**Sample Results:**\n\`\`\`\n$SUBDOMAINS_CONTENT\n\`\`\`"
          if [ ${#MESSAGE} -gt 1950 ]; then
            MESSAGE="✅ **Subdomain Discovery Complete**\n**Domain:** ${{ matrix.domain }}\n**Total Unique:** ${{ env.TOTAL_SUBDOMAINS_FOUND }}\n(Result list truncated)"
          fi
          curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Run Nuclei for ${{ matrix.domain }}
        run: |
          nuclei -l subdomains.txt -severity critical,high,medium -silent -o nuclei-results.txt || true
          [ -f nuclei-results.txt ] || touch nuclei-results.txt
          echo "NUCLEI_VULNS_FOUND=$(wc -l < nuclei-results.txt)" >> $GITHUB_ENV

      - name: Notify Vulnerability Summary for ${{ matrix.domain }}
        run: |
          if [ "${{ env.NUCLEI_VULNS_FOUND }}" -gt 0 ]; then
              MESSAGE="🚨 **Vulnerabilities Found!**\n**Domain:** ${{ matrix.domain }}\n**Total:** ${{ env.NUCLEI_VULNS_FOUND }}\n\nSending details..."
          else
              MESSAGE="✅ **Vulnerability Scan Complete**\n**Domain:** ${{ matrix.domain }}\nNo critical/high/medium vulnerabilities found."
          fi
          curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": \"$MESSAGE\"}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Send Nuclei Vulnerabilities for ${{ matrix.domain }}
        if: env.NUCLEI_VULNS_FOUND != '0'
        run: |
          while IFS= read -r vuln; do
              MESSAGE="🚨 **Nuclei Vulnerability Found**\n**Domain:** ${{ matrix.domain }}\n\`\`\`\n$vuln\n\`\`\`"
              curl -s -X POST -H "Content-Type: application/json" -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" "${{ env.DISCORD_WEBHOOK }}" || true
              sleep 1
          done < nuclei-results.txt

      - name: Upload Artifacts for ${{ matrix.domain }}
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ matrix.domain }}
          path: |
            subdomains.txt
            nuclei-results.txt
